<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>LifeBite</title>
  <meta name="description" content="Track daily moments and get personalized life advice" />
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" href="icons/favicon.png" />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root{
      --bg: #0b1020;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --brand:#7c3aed;
      --brand-2:#06b6d4;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --border: rgba(148,163,184,.18);
      --ring: rgba(124,58,237,.25);
      --safe-bottom: env(safe-area-inset-bottom, 0);
      --safe-top: env(safe-area-inset-top, 0);
      --radius: 14px;

      /* week chip colors */
      --chip-fg: #e5e7eb;         /* number/dow on dark (inactive) */
      --chip-fg-muted: #94a3b8;
      --chip-active-fg: #ffffff;  /* active number/dow */
      --chip-bg: var(--card);

      /* runtime-computed via JS */
      --composer-h: 72px;
      --main-bottom-pad: calc(var(--composer-h) + 16px);
    }
    @media (prefers-color-scheme: light){
      :root:not([data-theme="dark"]){
        --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#64748b; --border: rgba(15,23,42,.08);
        --chip-fg:#111827; --chip-fg-muted:#64748b; --chip-active-fg:#ffffff;
      }
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#64748b; --border: rgba(15,23,42,.08);
      --chip-fg:#111827; --chip-fg-muted:#64748b; --chip-active-fg:#ffffff;
    }
    :root[data-theme="dark"]{
      --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border: rgba(148,163,184,.18);
      --chip-fg:#e5e7eb; --chip-fg-muted:#94a3b8; --chip-active-fg:#ffffff;
    }

    *{ box-sizing:border-box; min-width:0; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background:var(--bg); -webkit-tap-highlight-color: transparent;
      background: linear-gradient(180deg, var(--bg), color-mix(in srgb, var(--bg) 80%, #000) 30%, var(--bg) 100%);
    }

    .app{
      width:100%;
      max-width: 680px;
      margin: 0 auto;
      display:grid;
      grid-template-rows: auto 1fr;
      min-height: 100dvh;
    }

    header{
      position: sticky; top:0; z-index: 20;
      backdrop-filter: saturate(180%) blur(10px);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border-bottom: 1px solid var(--border);
      width: 100%;
    }
    .topbar{
      display:flex; align-items:center; gap:10px;
      padding: calc(10px + var(--safe-top)) 14px 10px;
    }
    .logo{ font-weight:700; letter-spacing:.2px; display:flex; gap:10px; align-items:center; }
    .logo i{ color: var(--brand); }
    .spacer{ flex:1; }
    .icon-btn{
      appearance:none; border:0; background:transparent; color:var(--text);
      width:40px; height:40px; border-radius:12px;
      display:grid; place-items:center; font-size:18px; cursor:pointer;
      flex: 0 0 auto;
    }

    .date-bar{ padding: 10px 14px 0 14px; }
    .date-head{
      background: var(--card); border:1px solid var(--border); border-radius: var(--radius);
      display:flex; align-items:center; gap:8px; padding: 8px; width:100%;
    }
    .date-head .btn{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; flex:0 0 auto;
    }
    .date-title{
      flex:1; text-align:center; font-weight:600; letter-spacing:.2px;
      display:flex; flex-direction:column; align-items:center; gap:2px; user-select:none; min-width:0;
    }
    .date-title .sub{ color:var(--muted); font-size:12px; font-weight:500; }
    .today-pill{
      border:1px solid var(--border); background:transparent; color:var(--brand);
      padding:8px 10px; border-radius:10px; font-weight:600; font-size:12px; cursor:pointer; flex:0 0 auto;
    }

    /* Week strip wrapper */
    .week-wrap{ padding: 0 8px 12px 8px; }
    /* Responsive week strip:
       - If 7 chips fit, show a 7-col grid (no scroll).
       - If not, horizontal scroll with snap and chip size scaling. */
    .week-strip{
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(clamp(48px, 12vw, 68px), 1fr);
      gap: 8px;
      overflow-x:auto; -webkit-overflow-scrolling: touch; scrollbar-width:none;
      scroll-snap-type: x proximity;
      padding: 4px 6px;
      border-radius: 12px;
    }
    .week-strip::-webkit-scrollbar{ display:none; }
    .week-strip.full{
      grid-auto-flow: initial;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      overflow-x: hidden;
      scroll-snap-type: none;
    }

    .day-chip{
      border:1px solid var(--border); border-radius:12px;
      background: var(--chip-bg); padding:8px 6px; text-align:center; cursor:pointer; flex:0 0 auto;
      color: var(--chip-fg);
      user-select:none;
      scroll-snap-align: center;
      transition: transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .day-chip .dow{ font-size:11px; color: var(--chip-fg-muted); line-height:1.1; }
    .day-chip .d{ font-size: clamp(14px, 2.8vw, 18px); font-weight:700; margin-top:2px; color: inherit; }
    .day-chip .dot{ width:6px; height:6px; border-radius:999px; margin:6px auto 0; background:transparent; }
    .day-chip.active{
      border-color: transparent;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: var(--chip-active-fg);
      transform: scale(1.02);
    }
    .day-chip.active .dow{ color: color-mix(in srgb, white 85%, transparent); }
    .day-chip.haslogs .dot{ background: var(--brand-2); }

    main{
      min-height: 0;
      overflow: auto;
      padding: 16px;
      padding-bottom: var(--main-bottom-pad);
      width:100%;
    }
    .panel{ background: var(--card); border:1px solid var(--border); border-radius: var(--radius); padding:16px; margin-bottom:16px; width:100%; }

    .logs-head{
      display:flex; align-items:center; gap:8px; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap;
    }
    .logs-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-outline{
      border:1px solid var(--border); background:transparent; color:var(--text);
      padding:8px 10px; border-radius:10px; font-weight:600; font-size:12px; cursor:pointer; flex:0 0 auto;
    }
    .btn-danger{ border-color: color-mix(in srgb, var(--err) 40%, var(--border)); color: var(--err); }
    .btn-accent{ border-color: color-mix(in srgb, var(--brand-2) 50%, var(--border)); color: var(--brand-2); }

    .badges{ display:flex; align-items:center; gap:8px; }
    #savedBadge{ display:none; }
    .spin{
      width:18px; height:18px; border-radius:50%;
      border:2px solid color-mix(in srgb, var(--brand) 20%, var(--border));
      border-top-color: var(--brand);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .flex-col{ display:flex; flex-direction:column; min-height:0; }
    .log-list{ list-style:none; margin:0; padding:0; overflow:auto; width:100%; }
    .log-item{ border-top:1px dashed var(--border); padding:10px 4px; display:grid; gap:4px; }
    .log-item:first-child{ border-top:0; }
    .log-time{ font-size:11px; color:var(--muted); }
    .empty{ display:grid; place-items:center; padding:22px; color:var(--muted); text-align:center; gap:8px; }

    .result-card + .result-card{ margin-top:10px; }
    .result-head{ font-weight:700; display:flex; align-items:center; gap:8px; color: var(--brand); }
    .summary{
      background: color-mix(in srgb, var(--brand) 18%, transparent);
      border:1px solid color-mix(in srgb, var(--brand) 35%, var(--border));
      color: var(--text); padding:12px; border-radius:12px; font-weight:600; margin-bottom:10px;
    }
    .result-list{ margin:8px 0 0 20px; padding:0; }
    .error{ text-align:center; font-size:14px; color:var(--muted); padding:10px; }

    .composer{
      position: sticky; bottom: 0; z-index: 15;
      padding: 10px 14px calc(10px + var(--safe-bottom));
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 80%, transparent);
      border-top:1px solid var(--border);
    }
    .compose-row{ display:grid; grid-template-columns: 1fr 56px; gap:8px; align-items: stretch; }
    textarea{
      resize:none; border:1px solid var(--border); border-radius: 12px; padding:12px 12px 8px;
      font: 16px/1.35 Inter, system-ui; color:var(--text); background: var(--card);
      min-height: 48px; max-height: 144px; outline:none; width:100%;
    }
    .send{ appearance:none; border:0; border-radius:12px; background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:white; font-weight:700; cursor:pointer; font-size:18px; display:grid; place-items:center; }
    .meta{ display:flex; justify-content:space-between; align-items:center; padding:4px 2px 0; color:var(--muted); font-size:12px; }
    .count.limit{ color: var(--err); }

    .modal{ position: fixed; inset:0; display:none; place-items:center; z-index:50; background: rgba(0,0,0,.5); }
    .modal.open{ display:grid; animation: fade .15s ease-out; }
    @keyframes fade{ from{ opacity:0 } to{ opacity:1 } }
    .sheet{
      width:min(92vw, 560px);
      background: var(--card); border-radius:20px; border:1px solid var(--border);
      padding:16px 20px 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-height: min(80dvh, 640px); overflow:auto;
    }
    .sheet-head{ display:flex; align-items:center; justify-content:space-between; padding:6px 4px 14px; }
    .cal-title{ font-weight:700; }
    .cal-nav{ display:flex; gap:8px; flex-wrap:wrap; }
    .cal-btn{ width:36px; height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); }
    .cal-grid{ margin-top:8px; display:grid; grid-template-columns: repeat(7,1fr); gap:6px; }
    .dow-h{ text-align:center; font-size:11px; color:var(--muted); padding:6px 0; }
    .day{ height:46px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text); display:grid; place-items:center; position:relative; cursor:pointer; }
    .day[disabled]{ opacity:.45; pointer-events:none; }
    .day .badge{ position:absolute; bottom:6px; left:50%; transform:translateX(-50%); width:7px; height:7px; border-radius:999px; background: var(--brand-2); }
    .day.today{ outline:2px solid var(--ring); }
    .day.selected{ background: color-mix(in srgb, var(--brand) 20%, transparent); border-color: color-mix(in srgb, var(--brand) 40%, var(--border)); }

    .dialog{ position: fixed; inset:0; display:none; place-items:center; z-index:60; background: rgba(0,0,0,.55); }
    .dialog.open{ display:grid; }
    .dialog-card{ width:min(92vw, 420px); background: var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .dialog-title{ font-weight:700; margin-bottom:6px; }
    .dialog-body{ color:var(--muted); font-size:14px; }
    .dialog-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); font-weight:600; cursor:pointer; }
    .btn.primary{ background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:white; border:0; }

    .offline{
      position: fixed; top: calc(6px + var(--safe-top)); left:50%; transform: translateX(-50%);
      background: color-mix(in srgb, var(--warn) 15%, var(--card)); color:var(--text);
      border:1px dashed color-mix(in srgb, var(--warn) 45%, var(--border));
      padding:6px 10px; border-radius:999px; font-size:12px; z-index:70; display:none; max-width: 90vw; white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .offline.show{ display:block; }

    [hidden]{ display:none !important; }

    @media (max-width: 380px){
      .date-head{ padding:6px; gap:4px; }
      .date-head .btn{ width:36px; height:36px; }
      .today-pill{ padding:6px 8px; font-size:11px; }
      #dateMain{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 52vw; }
      .panel{ padding:12px; }
      .btn-outline{ padding:6px 8px; }
    }

    @supports(padding: max(0px)){
      .composer{ padding-bottom: max(10px, calc(10px + var(--safe-bottom))); }
    }

    @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }
    input, button, textarea { appearance: none; -webkit-appearance: none; border-radius: var(--radius); }
  </style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="topbar">
      <div class="logo"><i class="fa-solid fa-bolt"></i> LifeBite</div>
      <div class="spacer"></div>
      <!-- Right actions: theme, settings, insights -->
      <button class="icon-btn" id="themeToggle" aria-label="Toggle theme"><i class="fa-solid fa-moon"></i></button>
      <button class="icon-btn" id="settingsBtn" aria-label="Settings"><i class="fa-solid fa-gear"></i></button>
      <button class="icon-btn" id="insightsBtn" aria-label="Insights"><i class="fa-solid fa-chart-line"></i></button>
    </div>

    <div class="date-bar">
      <div class="date-head">
        <button class="btn" id="prevDay" aria-label="Previous day"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="date-title" id="dateTitle" role="button" aria-label="Open calendar">
          <div id="dateMain">Today</div>
          <div class="sub" id="dateSub">Mon, Aug 17</div>
        </div>
        <button class="btn" id="nextDay" aria-label="Next day"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="today-pill" id="jumpToday">Today</button>
      </div>
    </div>

    <!-- Week strip -->
    <div class="week-wrap">
      <div class="week-strip" id="weekStrip" aria-label="Week strip"></div>
    </div>
  </header>

  <main>
    <!-- Logs -->
    <section class="panel flex-col" aria-labelledby="logsTitle">
      <div class="logs-head">
        <div style="display:flex; align-items:center; gap:8px;">
          <div id="logsTitle" style="font-weight:700;">Today’s Logs</div>
          <div class="badges">
            <span id="savedBadge" class="btn-outline btn-accent">Saved</span>
            <span id="analyzingSpin" class="spin" hidden title="Analyzing"></span>
          </div>
        </div>
        <div class="logs-actions">
          <button class="btn-outline btn-danger" id="clearDay"><i class="fa-solid fa-trash"></i> Clear</button>
          <button class="btn-outline" id="genSummary"><i class="fa-solid fa-brain"></i> Summary</button>
        </div>
      </div>

      <ul class="log-list" id="logList" role="list"></ul>
      <div class="empty" id="emptyState" hidden>
        <i class="fa-solid fa-pencil"></i>
        <div>No logs for this day.</div>
      </div>
    </section>

    <!-- Results -->
    <section class="panel" id="resultsPanel" hidden>
      <div id="resultsContainer"></div>
      <div class="error" id="errorState" hidden><i class="fa-solid fa-circle-exclamation"></i> Couldn’t generate advice. Try again.</div>
    </section>
  </main>

  <!-- Sticky Composer -->
  <div class="composer" id="composerWrap">
    <div class="compose-row">
      <textarea id="composer" placeholder="What happened? (max 280 chars)" maxlength="280" rows="1"></textarea>
      <button class="send" id="send"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
    <div class="meta">
      <div id="streakText">Streak: 0</div>
      <div><span id="charCount" class="count">0/280</span></div>
    </div>
  </div>
</div>

<!-- Offline banner -->
<div class="offline" id="offlineBanner"><i class="fa-solid fa-wifi"></i> You’re offline. Actions will queue.</div>

<!-- Calendar Modal -->
<div class="modal" id="calendarModal" aria-hidden="true">
  <div class="sheet">
    <div class="sheet-head">
      <button class="cal-btn" id="calPrev" aria-label="Previous month"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="cal-title" id="calTitle">August 2025</div>
      <div class="cal-nav">
        <button class="cal-btn" id="calToday" aria-label="Jump to today"><i class="fa-solid fa-bullseye"></i></button>
        <button class="cal-btn" id="calNext" aria-label="Next month"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="cal-btn" id="calClose" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="dialog" id="confirmDialog" aria-hidden="true">
  <div class="dialog-card">
    <div class="dialog-title" id="confirmTitle">Clear data?</div>
    <div class="dialog-body" id="confirmBody">This permanently deletes logs and summary for this day.</div>
    <div class="dialog-actions">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">Clear</button>
    </div>
  </div>
</div>

<!-- Settings Dialog -->
<div class="dialog" id="settingsDialog" aria-hidden="true">
  <div class="dialog-card">
    <div class="dialog-title">Settings</div>
    <div class="dialog-body">
      <div style="display:grid; gap:10px; margin-top:8px;">
        <label style="font-size:12px; color:var(--muted);">AI Endpoint</label>
        <input id="endpoint" style="padding:10px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text);" value="https://lifebite.vercel.app/api/lifebite" />

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="exportBtn"><i class="fa-solid fa-file-export"></i> Export</button>
          <label class="btn" for="importInput" style="cursor:pointer;"><i class="fa-solid fa-file-import"></i> Import</label>
          <input id="importInput" type="file" accept="application/json" hidden />
          <button class="btn" id="themeSystem"><i class="fa-solid fa-circle-half-stroke"></i> System</button>
          <button class="btn" id="themeLight"><i class="fa-regular fa-sun"></i> Light</button>
          <button class="btn" id="themeDark"><i class="fa-solid fa-moon"></i> Dark</button>
        </div>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="settingsClose">Close</button>
      <button class="btn primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
const fmtISO = d => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
const clampToToday = d => (d > today) ? new Date(today) : d;
const today = new Date(); today.setHours(0,0,0,0);
let current = new Date(); current.setHours(0,0,0,0);
let calMonth = new Date(today.getFullYear(), today.getMonth(), 1);

const STORAGE_PREFIX = 'lifebite';
const keyLogs = (d)=> `${STORAGE_PREFIX}:logs:${fmtISO(d)}`;
const keySummary = (d)=> `${STORAGE_PREFIX}:summary:${fmtISO(d)}`;
const keyTheme = `${STORAGE_PREFIX}:theme`;
const keyEndpoint = `${STORAGE_PREFIX}:endpoint`;
const keyQueue = `${STORAGE_PREFIX}:queue`;
const inFuture = (d)=> d.getTime() > today.getTime();

function getLogs(d=current){ try{ return JSON.parse(localStorage.getItem(keyLogs(d))||'[]'); }catch{ return []; } }
function setLogs(arr, d=current){ localStorage.setItem(keyLogs(d), JSON.stringify(arr)); }
function getSummary(d=current){ try{ return JSON.parse(localStorage.getItem(keySummary(d))||'null'); }catch{ return null; } }
function setSummary(obj, d=current){ localStorage.setItem(keySummary(d), JSON.stringify(obj)); }
function getEndpoint(){ return localStorage.getItem(keyEndpoint) || $('#endpoint')?.value || 'https://lifebite.vercel.app/api/lifebite'; }
function setEndpoint(v){ localStorage.setItem(keyEndpoint, v); }
function dayHasLogs(d){ return getLogs(d).length > 0; }
function streak(){ let s=0, d=new Date(today); while(dayHasLogs(d)){ s++; d.setDate(d.getDate()-1); } return s; }

/* ---------- Theme (default = system) ---------- */
const themeStored = localStorage.getItem(keyTheme) || 'system';
applyTheme(themeStored);
$('#themeToggle').addEventListener('click', ()=>{
  const cur = localStorage.getItem(keyTheme) || 'system';
  const next = (cur==='dark') ? 'light' : (cur==='light' ? 'system' : 'dark'); // cycle system -> dark -> light
  localStorage.setItem(keyTheme,next); applyTheme(next);
});
$('#themeSystem').addEventListener('click', ()=>{ localStorage.setItem(keyTheme,'system'); applyTheme('system'); });
$('#themeLight').addEventListener('click', ()=>{ localStorage.setItem(keyTheme,'light'); applyTheme('light'); });
$('#themeDark').addEventListener('click', ()=>{ localStorage.setItem(keyTheme,'dark'); applyTheme('dark'); });

function applyTheme(mode){
  if(mode==='system'){ document.documentElement.removeAttribute('data-theme'); }
  else{ document.documentElement.setAttribute('data-theme', mode); }
  const dark = (mode==='system') ? window.matchMedia('(prefers-color-scheme: dark)').matches : (mode==='dark');
  $('#themeToggle').querySelector('i').className = dark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
}

/* ---------- Header + Week Strip ---------- */
const daysShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const monthsLong = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function renderHeader(){
  const isToday = current.getTime()===today.getTime();
  $('#dateMain').textContent = isToday ? 'Today' : `${monthsLong[current.getMonth()]} ${current.getDate()}, ${current.getFullYear()}`;
  $('#dateSub').textContent = `${daysShort[current.getDay()]}, ${monthsLong[current.getMonth()].slice(0,3)} ${current.getDate()}`;
  $('#logsTitle').textContent = isToday ? "Today’s Logs" : "Logs";
  $('#nextDay').disabled = isToday;
  $('#jumpToday').disabled = isToday;
  $('#savedBadge').style.display = getSummary(current) ? 'inline-flex' : 'none';
  $('#streakText').textContent = `Streak: ${streak()}`;
}

function weekStart(d){ const t = new Date(d); const diff = t.getDay(); t.setDate(t.getDate()-diff); return t; }

function renderWeekStrip(){
  const root = $('#weekStrip'); root.innerHTML='';
  const start = weekStart(current);
  for(let i=0;i<7;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const chip = document.createElement('button');
    chip.className='day-chip'+(fmtISO(d)===fmtISO(current)?' active':'') + (dayHasLogs(d)?' haslogs':'');
    chip.setAttribute('data-date', fmtISO(d));
    chip.innerHTML = `<div class="dow">${daysShort[d.getDay()]}</div><div class="d">${d.getDate()}</div><div class="dot"></div>`;
    chip.disabled = inFuture(d);
    chip.addEventListener('click', ()=>{ current = d; afterDateChanged(); });
    root.appendChild(chip);
  }
  updateWeekLayout(); // responsive mode
  centerActiveChip();
}

/* Determine if 7 chips fit; if not, use scrollable mode */
function updateWeekLayout(){
  const ws = $('#weekStrip');
  const chips = $$('.day-chip', ws);
  if(!chips.length){ ws.classList.remove('full'); return; }
  // Measure first chip width and gap to decide if seven fit
  const cs = getComputedStyle(ws);
  const gap = parseFloat(cs.columnGap || cs.gap) || 8;
  const chipW = chips[0].getBoundingClientRect().width || 56;
  const total = chipW * 7 + gap * 6 + 2; // buffer
  const fits = ws.clientWidth >= total;
  ws.classList.toggle('full', fits);
}
function centerActiveChip(){
  const ws = $('#weekStrip');
  if(ws.classList.contains('full')) return; // no need
  const active = $('.day-chip.active', ws);
  if(active) active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
}

/* Swipe on header */
let touchX = null;
$('header').addEventListener('touchstart', e=>{ touchX = e.touches[0].clientX; }, {passive:true});
$('header').addEventListener('touchend', e=>{
  if(touchX===null) return;
  const dx = e.changedTouches[0].clientX - touchX;
  if(Math.abs(dx) > 50){ navigate(dx<0? +1 : -1); }
  touchX = null;
});

/* ---------- Calendar ---------- */
const calModal = $('#calendarModal');
$('#dateTitle').addEventListener('click', openCalendar);
$('#calClose').addEventListener('click', closeCalendar);
$('#calPrev').addEventListener('click', ()=>{ calMonth.setMonth(calMonth.getMonth()-1); renderCalendar(); });
$('#calNext').addEventListener('click', ()=>{
  const next = new Date(calMonth); next.setMonth(next.getMonth()+1);
  const afterNext = new Date(next.getFullYear(), next.getMonth()+1, 0);
  if(afterNext > today){ return; }
  calMonth = next; renderCalendar();
});
$('#calToday').addEventListener('click', ()=>{ calMonth = new Date(today.getFullYear(), today.getMonth(), 1); renderCalendar(); });

function openCalendar(){ calMonth = new Date(current.getFullYear(), current.getMonth(), 1); renderCalendar(); calModal.classList.add('open'); calModal.setAttribute('aria-hidden','false'); }
function closeCalendar(){ calModal.classList.remove('open'); calModal.setAttribute('aria-hidden','true'); }
calModal.addEventListener('click', e=>{ if(e.target===calModal) closeCalendar(); });

function renderCalendar(){
  $('#calTitle').textContent = `${monthsLong[calMonth.getMonth()]} ${calMonth.getFullYear()}`;
  const grid = $('#calGrid'); grid.innerHTML='';
  daysShort.forEach(d=>{ const h=document.createElement('div');h.textContent=d;h.className='dow-h';grid.appendChild(h); });

  const first = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1);
  const last  = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 0);
  const startOffset = first.getDay();
  const totalCells = Math.ceil((startOffset + last.getDate())/7)*7;

  for(let i=0;i<totalCells;i++){
    const cell = document.createElement('button'); cell.className='day';
    const dateNum = i - startOffset + 1;
    if(dateNum < 1 || dateNum > last.getDate()){ cell.setAttribute('disabled',''); cell.style.visibility='hidden'; grid.appendChild(cell); continue; }
    const d = new Date(calMonth.getFullYear(), calMonth.getMonth(), dateNum);
    cell.textContent = dateNum;
    if(inFuture(d)) cell.setAttribute('disabled','');
    if(fmtISO(d)===fmtISO(today)) cell.classList.add('today');
    if(fmtISO(d)===fmtISO(current)) cell.classList.add('selected');
    if(dayHasLogs(d)){ const b=document.createElement('div'); b.className='badge'; cell.appendChild(b); }
    cell.addEventListener('click', ()=>{ current = d; afterDateChanged(); closeCalendar(); });
    grid.appendChild(cell);
  }
}

/* ---------- Navigation ---------- */
$('#prevDay').addEventListener('click', ()=> navigate(-1));
$('#nextDay').addEventListener('click', ()=> navigate(+1));
$('#jumpToday').addEventListener('click', ()=>{ current = new Date(today); afterDateChanged(); });
function navigate(offset){ const nd = new Date(current); nd.setDate(current.getDate()+offset); current = clampToToday(nd); afterDateChanged(); }

function afterDateChanged(){
  renderHeader(); renderWeekStrip(); renderLogs(); renderResultsBadge();
  $('#resultsPanel').hidden = true;
  layoutPass();
}

/* ---------- Logs ---------- */
const logList = $('#logList');
const emptyState = $('#emptyState');

function renderLogs(){
  const logs = getLogs();
  logList.innerHTML = '';
  if(!logs || logs.length === 0){
    emptyState.hidden = false; logList.hidden = true;
  }else{
    emptyState.hidden = true; logList.hidden = false;
    logs.forEach(l=>{
      const li = document.createElement('li'); li.className='log-item';
      const txt = document.createElement('div'); txt.textContent = l.text;
      const tm  = document.createElement('div'); tm.className='log-time';
      const d = new Date(l.timestamp); tm.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      li.appendChild(txt); li.appendChild(tm); logList.appendChild(li);
    });
    logList.scrollTop = 0;
  }
}

/* ---------- Composer ---------- */
const composer = $('#composer');
const sendBtn = $('#send');
const charCount = $('#charCount');

composer.addEventListener('input', ()=>{
  composer.style.height = 'auto';
  composer.style.height = Math.min(composer.scrollHeight, 144) + 'px';
  const len = composer.value.length;
  charCount.textContent = `${len}/280`;
  charCount.classList.toggle('limit', len>250);
  layoutPass();
});
composer.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); addLog(); }
});
sendBtn.addEventListener('click', addLog);

function addLog(){
  const text = composer.value.trim();
  if(!text) return;
  if(text.length>280){ alert('Max 280 characters.'); return; }
  if(inFuture(current)){ alert('Cannot add logs to future dates.'); return; }

  const logs = getLogs();
  logs.unshift({ text, timestamp: new Date().toISOString() });
  setLogs(logs);
  composer.value=''; composer.dispatchEvent(new Event('input'));
  renderLogs(); renderWeekStrip(); renderHeader();
  emptyState.hidden = true; logList.hidden = false;
}

/* ---------- Clear Day (also hide/clear visible summary) ---------- */
const confirmDlg = $('#confirmDialog');
$('#clearDay').addEventListener('click', ()=>{
  $('#confirmTitle').textContent = `Clear ${fmtISO(current)}?`;
  $('#confirmBody').textContent = 'This will permanently delete all logs and the LifeBite summary for this day.';
  confirmDlg.classList.add('open'); confirmDlg.setAttribute('aria-hidden','false');
});
$('#confirmCancel').addEventListener('click', ()=>{ confirmDlg.classList.remove('open'); confirmDlg.setAttribute('aria-hidden','true'); });
$('#confirmOk').addEventListener('click', ()=>{
  localStorage.removeItem(keyLogs(current));
  localStorage.removeItem(keySummary(current));
  $('#resultsPanel').hidden = true;
  $('#resultsContainer').innerHTML = '';
  $('#errorState').hidden = true;

  renderLogs(); renderResultsBadge(); renderWeekStrip(); renderHeader();
  confirmDlg.classList.remove('open'); confirmDlg.setAttribute('aria-hidden','true');
  layoutPass();
});

/* ---------- Summary / AI (spinner at Saved area) ---------- */
const resultsPanel = $('#resultsPanel');
const resultsContainer = $('#resultsContainer');
const errorState = $('#errorState');
const analyzingSpin = $('#analyzingSpin');

$('#genSummary').addEventListener('click', ()=>{
  const saved = getSummary();
  if(saved){ displayResults(saved); return; }
  generateSummary();
});

function renderResultsBadge(){ $('#savedBadge').style.display = getSummary(current) ? 'inline-flex' : 'none'; }

function displayResults(result){
  analyzingSpin.hidden = true;
  errorState.hidden = true;
  resultsPanel.hidden = false;

  let html = '';
  if(result.summary){ html += `<div class="result-card"><div class="summary">${escapeHTML(result.summary)}</div></div>`; }
  html += section('Keep Doing', result.keep_doing, 'fa-thumbs-up');
  html += section('Areas to Improve', result.improve, 'fa-arrow-trend-up');
  html += section('Schedule Adjustments', result.schedule_tweaks, 'fa-calendar-alt');
  html += section('Next Actions', result.next_actions, 'fa-square-check');
  resultsContainer.innerHTML = html;
  renderResultsBadge();
  resultsPanel.scrollIntoView({behavior:'smooth'});
  layoutPass();
}
function section(title, items, icon){
  if(!items || !items.length) return '';
  const lis = items.map(i=>`<li>${escapeHTML(i)}</li>`).join('');
  return `<div class="result-card"><div class="result-head"><i class="fa-solid ${icon}"></i> ${title}</div><ul class="result-list">${lis}</ul></div>`;
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function generateSummary(){
  const logs = getLogs();
  if(!logs.length){ alert('Add at least one log first.'); return; }

  analyzingSpin.hidden = false;
  resultsPanel.hidden = true;
  resultsContainer.innerHTML='';
  errorState.hidden = true;

  const payload = { date: fmtISO(current), logs: logs.map(l=>l.text) };
  const endpoint = getEndpoint();

  if(!navigator.onLine){
    enqueue({ type:'summary', endpoint, payload });
    analyzingSpin.hidden = true;
    errorState.hidden = false; errorState.textContent = 'Offline. Queued—will run automatically when back online.';
    resultsPanel.hidden = false;
    return;
  }

  try{
    const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error(String(res.status));
    const data = await res.json();
    setSummary(data.result, current);
    displayResults(data.result);
  }catch(e){
    analyzingSpin.hidden = true;
    resultsPanel.hidden = false;
    errorState.hidden = false;
  }
}

/* ---------- Offline queue ---------- */
window.addEventListener('online', flushQueue);
function getQueue(){ try{ return JSON.parse(localStorage.getItem(keyQueue) || '[]'); }catch{ return []; } }
function setQueue(q){ localStorage.setItem(keyQueue, JSON.stringify(q)); }
function enqueue(job){ const q = getQueue(); q.push(job); setQueue(q); showOffline(true); }
async function flushQueue(){
  const q = getQueue(); if(!q.length) return;
  for(const job of q){
    if(job.type==='summary'){
      try{
        const res = await fetch(job.endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(job.payload) });
        if(res.ok){
          const data = await res.json();
          if(job.payload?.date){ const d = new Date(job.payload.date); setSummary(data.result, d); }
        }
      }catch{}
    }
  }
  setQueue([]); showOffline(false); renderResultsBadge();
}

/* ---------- Connectivity banner ---------- */
function showOffline(state){ $('#offlineBanner').classList.toggle('show', state); }
window.addEventListener('online', ()=>showOffline(false));
window.addEventListener('offline', ()=>showOffline(true));
showOffline(!navigator.onLine);

/* ---------- Settings / Export / Import ---------- */
$('#settingsBtn').addEventListener('click', ()=>{ $('#endpoint').value = getEndpoint(); $('#settingsDialog').classList.add('open'); $('#settingsDialog').setAttribute('aria-hidden','false'); });
$('#settingsClose').addEventListener('click', ()=>{ $('#settingsDialog').classList.remove('open'); $('#settingsDialog').setAttribute('aria-hidden','true'); });
$('#saveSettings').addEventListener('click', ()=>{ setEndpoint($('#endpoint').value.trim()); $('#settingsDialog').classList.remove('open'); $('#settingsDialog').setAttribute('aria-hidden','true'); });

$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(Object.entries(localStorage).reduce((obj,[k,v])=>{ if(k.startsWith(STORAGE_PREFIX)) obj[k]=v; return obj; },{}), null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `lifebite-backup-${fmtISO(today)}.json`; a.click();
});
$('#importInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    Object.entries(obj).forEach(([k,v])=> localStorage.setItem(k, v));
    afterDateChanged();
    alert('Import complete.');
  }catch{ alert('Invalid file.'); }
});

/* ---------- Insights button (top-right) ---------- */
$('#insightsBtn').addEventListener('click', ()=>{
  alert('Insights coming soon: streak heatmap, time-of-day trends, habit tags.');
});

/* ---------- Layout engine ---------- */
function updateInsets(){
  const composerH = $('#composerWrap').getBoundingClientRect().height || 72;
  document.documentElement.style.setProperty('--composer-h', composerH + 'px');
  document.documentElement.style.setProperty('--main-bottom-pad', `calc(${composerH}px + 16px)`);
}
function layoutPass(){
  updateInsets();
  const vb = window.innerHeight;
  const listTop = $('#logList').getBoundingClientRect().top;
  const safe = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-bottom')) || 0;

  let avail = vb - listTop - (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--composer-h'))||72) - safe - 24;
  if (avail < 120) avail = 120;
  $('#logList').style.maxHeight = avail + 'px';

  updateWeekLayout();
}
window.addEventListener('resize', ()=>{ requestAnimationFrame(layoutPass); });
window.addEventListener('orientationchange', ()=>{ setTimeout(layoutPass, 50); });

/* ---------- Init ---------- */
function init(){
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  renderHeader(); renderWeekStrip(); renderLogs(); renderResultsBadge(); renderCalendar();
  if(!localStorage.getItem(keyEndpoint)){ setEndpoint(getEndpoint()); }
  layoutPass();
  const mql = window.matchMedia('(prefers-color-scheme: dark)');
  mql.addEventListener?.('change', ()=>{ if((localStorage.getItem(keyTheme)||'system')==='system') applyTheme('system'); });
}
init();
</script>
</body>
</html>

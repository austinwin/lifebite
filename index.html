<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>LifeBite</title>
  <meta name="description" content="Track daily moments and get personalized life advice" />
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" href="icons/favicon.png" />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
/* =========================================================
   LifeBite – Mobile-first, compact, $10B UI density pass
   ========================================================= */

/* ----------- TOKENS / THEME ----------- */
:root{
  /* dark defaults; system/light overrides below */
  --bg: #0f172a;
  --card: #0b1222;
  --elev: #111a2f;
  --text: #e5e7eb;
  --muted: #9aa3b2;
  --brand: #7c8cff;
  --brand-2: #20c3ff;
  --ok: #10b981;
  --warn: #f59e0b;
  --err: #ef4444;
  --border: rgba(148,163,184,.22);
  --ring: rgba(124,140,255,.35);

  --shadow-sm: 0 1px 2px rgba(0,0,0,.25);
  --shadow:    0 2px 8px rgba(0,0,0,.30);
  --shadow-md: 0 8px 18px rgba(0,0,0,.35);
  --shadow-lg: 0 18px 32px rgba(0,0,0,.45);

  --radius: 14px;
  --radius-sm: 10px;
  --radius-full: 9999px;

  --safe-bottom: env(safe-area-inset-bottom, 0);
  --safe-top:    env(safe-area-inset-top, 0);

  /* compact spacing tuned for small screens */
  --container-pad: clamp(8px, 3.2vw, 14px);
  --content-gap:  clamp(6px, 1.6vw, 12px);
  --header-gap:   6px;
  --week-gap:     6px;
}

/* Respect user's system theme unless explicitly overridden */
@media (prefers-color-scheme: light){
  :root:not([data-theme="dark"]){
    --bg: #f6f7fb;
    --card: #ffffff;
    --elev: #ffffff;
    --text: #0f172a;
    --muted: #667085;
    --border: rgba(203,213,225,.55);
    --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
    --shadow:    0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
    --shadow-md: 0 8px 16px rgba(0,0,0,.06);
    --shadow-lg: 0 18px 32px rgba(0,0,0,.10);
  }
}
:root[data-theme="light"]{
  --bg: #f6f7fb;
  --card: #ffffff;
  --elev: #ffffff;
  --text: #0f172a;
  --muted: #667085;
  --border: rgba(203,213,225,.55);
  --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
  --shadow:    0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
  --shadow-md: 0 8px 16px rgba(0,0,0,.06);
  --shadow-lg: 0 18px 32px rgba(0,0,0,.10);
}
/* :root[data-theme="dark"] stays as defaults */

/* ----------- BASE ----------- */
*{ box-sizing:border-box; min-width:0; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--text);
  background: radial-gradient(1000px 600px at 50% -200px, rgba(124,140,255,.12), transparent 60%), var(--bg);
  -webkit-tap-highlight-color: transparent;
  font-size: 15px;
  line-height: 1.5;
}

/* ----------- APP SHELL ----------- */
.app{
  width: 100%;
  max-width: min(100%, 720px);
  height: 100dvh;
  margin: 0 auto;
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 0;
  background: transparent;
}

/* ----------- HEADER / TOPBAR ----------- */
header{
  position: relative;
  z-index: 20;
  background: transparent;
  padding-top: var(--safe-top);
}
.topbar{
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px var(--container-pad) 2px;
}
.logo{
  font-weight: 800;
  letter-spacing: .2px;
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 18px;
  color: var(--text);
}
.logo i{
  color: var(--brand);
  font-size: 20px;
  filter: drop-shadow(0 2px 6px rgba(124,140,255,.35));
}
.spacer{ flex: 1; }
.icon-btn{
  appearance: none; border: 0; background: transparent; color: var(--text);
  width: 40px; height: 40px; border-radius: var(--radius-sm);
  display: grid; place-items: center; font-size: 18px; cursor: pointer;
  transition: background-color .15s ease, transform .1s ease;
}
.icon-btn:hover{ background-color: rgba(124,140,255,.12); }
.icon-btn:active{ transform: translateY(1px); }

/* ----------- PLANNER CARD (date + week) ----------- */
.planner{ padding: 0 var(--container-pad) 4px; }
.planner-card{
  border: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(124,140,255,.10), transparent 50%), var(--card);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 8px;
  display: grid;
  grid-template-columns: 40px 1fr 40px auto; /* keep 40px hit targets */
  grid-template-rows: auto auto;
  grid-template-areas:
    "prev title next today"
    "week week week week";
  gap: var(--header-gap);
  align-items: center;
}
@media (max-width: 420px){
  .planner-card{ grid-template-columns: 40px 1fr 40px auto; }
}
.nav-btn{
  width: 40px; height: 40px; border-radius: 12px;
  display: grid; place-items: center; cursor: pointer; flex: 0 0 auto;
  border: 1px solid var(--border);
  background: var(--elev); color: var(--text);
  transition: all .15s ease;
}
.nav-btn:hover:not(:disabled){ border-color: var(--brand); color: var(--brand); }
.nav-btn:disabled{ opacity:.5; cursor:not-allowed; }
#prevDay{ grid-area: prev; }
#nextDay{ grid-area: next; }

.date-title{
  grid-area: title;
  text-align: center;
  font-weight: 700;
  letter-spacing: .2px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  user-select: none;
  min-width: 0;
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 10px;
  transition: background-color .15s ease;
}
.date-title:hover{ background-color: rgba(124,140,255,.12); }
.date-sub{ color: var(--muted); font-size: 12px; font-weight: 500; }

.today-pill{
  grid-area: today;
  border: none;
  background: rgba(124,140,255,.15);
  color: var(--brand);
  padding: 6px 10px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
  transition: background-color .15s ease;
}
.today-pill:hover:not(:disabled){ background: rgba(124,140,255,.25); }
.today-pill:disabled{ opacity:.5; cursor:not-allowed; }

/* ----------- WEEK STRIP ----------- */
.week-strip{
  grid-area: week;
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: minmax(clamp(44px, 11.5vw, 64px), 1fr);
  gap: var(--week-gap);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  scroll-snap-type: x proximity;
  padding: 0 2px 2px;
}
.week-strip::-webkit-scrollbar{ display: none; }
.week-strip.full{
  grid-auto-flow: initial;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  overflow-x: hidden;
  scroll-snap-type: none;
}
.day-chip{
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--elev);
  padding: 8px 4px;
  text-align: center;
  cursor: pointer;
  color: var(--text);
  user-select: none;
  scroll-snap-align: center;
  transition: all .15s ease;
  box-shadow: var(--shadow-sm);
}
.day-chip .dow{ font-size: 11px; color: var(--muted); line-height: 1.1; }
.day-chip .d{ font-size: 15px; font-weight: 800; margin-top: 3px; color: inherit; }
.day-chip .dot{ width: 4px; height: 4px; border-radius: var(--radius-full); margin: 4px auto 0; background: transparent; }
.day-chip.active{
  border-color: transparent;
  background: linear-gradient(135deg, #7c8cff, #20c3ff);
  color: #fff;
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}
.day-chip.active .dow{ color: rgba(255,255,255,0.85); }
.day-chip.haslogs .dot{ background: #20c3ff; }
.day-chip:disabled{ opacity:.5; cursor:not-allowed; }

/* ----------- MAIN CONTENT ----------- */
main{
  padding: var(--content-gap) var(--container-pad);
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--content-gap);
  overflow: hidden;   /* only inner panes scroll */
  background: transparent;
  min-height: 0;
}
.panel{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 10px;               /* compact */
  width: 100%;
  box-shadow: var(--shadow);
  min-height: 0;               /* allow flex child to shrink */
}
.flex-col{ display:flex; flex-direction:column; min-height:0; flex:1; }

/* Logs header/actions */
.logs-head{
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: space-between;
  margin-bottom: 6px;
  flex-wrap: wrap;
}
.logs-actions{ display: flex; gap: 8px; flex-wrap: wrap; }
.btn-outline{
  border: 1px solid var(--border);
  background: var(--elev);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all .15s ease;
}
.btn-outline:hover{ border-color: var(--brand); color: var(--brand); }
.btn-danger{ border-color: rgba(239,68,68,0.4); color: var(--err); }
.btn-danger:hover{ border-color: var(--err); background: rgba(239,68,68,0.08); }

/* Logs list */
.log-list{ list-style:none; margin:0; padding:0; overflow:auto; width:100%; max-height:100%; }
.log-item { padding: 8px 0; border-bottom: 1px solid var(--border); }
.log-item:last-child{ border-bottom:none; }
.log-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
.log-time{ font-size:12px; color:var(--muted); }
.log-actions{ display:flex; gap:6px; }
.log-btn{
  background: transparent; border: 1px solid var(--border); color: var(--muted);
  font-size: 12px; cursor: pointer; padding: 2px 8px; border-radius: 999px;
  transition: all .15s ease;
}
.log-btn:hover{ color: var(--text); border-color: var(--brand); }
.log-content{ line-height:1.5; }

/* Results */
#resultsPanel{ display:flex; flex-direction:column; min-height:0; flex:1; }
#resultsContainer{ overflow-y:auto; scrollbar-width:thin; min-height:200px; }
#resultsContainer::-webkit-scrollbar{ width:6px; }
#resultsContainer::-webkit-scrollbar-thumb{ background-color:var(--muted); border-radius:var(--radius-full); }
.result-card + .result-card{ margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
.result-head{ font-weight:800; display:flex; align-items:center; gap:8px; color:var(--brand); margin-bottom:6px; }
.summary{
  background: rgba(124,140,255,0.12);
  border: 1px solid rgba(124,140,255,0.25);
  color: var(--text);
  padding: 12px;
  border-radius: 12px;
  font-weight: 500;
  margin-bottom: 12px;
  line-height: 1.6;
  max-height: 220px;      /* trimmed so it doesn't hog viewport */
  overflow-y: auto;
  scrollbar-width: thin;
}
.summary::-webkit-scrollbar{ width:6px; }
.summary::-webkit-scrollbar-thumb{ background-color:var(--muted); border-radius:var(--radius-full); }
.result-list{ margin:6px 0 0 24px; padding:0; line-height:1.6; }
.result-list li{ margin-bottom:6px; }
.error{
  text-align:center; font-size:14px; color:var(--muted);
  padding: 12px; display:flex; align-items:center; justify-content:center; gap:8px;
}

/* ----------- COMPOSER ----------- */
.composer{
  padding: 8px var(--container-pad) max(8px, calc(8px + var(--safe-bottom)));
  background: transparent;
}
.composer-card{
  border: 1px solid var(--border);
  background: var(--card);
  border-radius: 16px;
  padding: 8px;
  box-shadow: var(--shadow);
}
.compose-row{
  display: grid;
  grid-template-columns: 1fr 46px; /* compact but ≥40px tap */
  gap: 8px;
  align-items: flex-start;
}
textarea{
  resize: none;
  border: 1px dashed rgba(148,163,184,.35);
  border-radius: 12px;
  padding: 12px 14px;
  font: 15px/1.5 Inter, system-ui;
  color: var(--text);
  background: var(--elev);
  min-height: 46px;
  max-height: 140px;
  outline: none;
  width: 100%;
  box-shadow: var(--shadow-sm);
  transition: border-color .15s ease, background .15s ease;
  scrollbar-width: none; -ms-overflow-style: none;
}
textarea:focus{ border-color: var(--brand); background: rgba(124,140,255,.12); }
textarea::-webkit-scrollbar{ display: none; }

.send{
  appearance: none; border: 0; border-radius: 12px;
  background: linear-gradient(135deg, #7c8cff, #20c3ff);
  color: white; font-weight: 800; cursor: pointer; font-size: 18px;
  display: grid; place-items: center; box-shadow: var(--shadow);
  transition: transform .15s ease, box-shadow .15s ease; height: 46px;
}
.send:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); }
.send:active{ transform: translateY(0); }
.meta{
  margin: 6px 2px 0;
  display: flex; justify-content: space-between; align-items: center;
  color: var(--muted); font-size: 12px;
}
.count.limit{ color: var(--err); }

/* ----------- MODALS / DIALOGS ----------- */
.modal{
  position: fixed; inset: 0; display: none; place-items: center; z-index: 60;
  background: rgba(15,23,42,0.65); backdrop-filter: blur(4px);
}
.modal.open{ display: grid; animation: fade .15s ease-out; }
@keyframes fade{ from{ opacity: 0 } to{ opacity: 1 } }

.sheet{
  width: min(92vw, 560px); background: var(--card); border-radius: 16px;
  border: 1px solid var(--border); padding: 20px; box-shadow: var(--shadow-lg);
  max-height: min(80dvh, 640px); overflow: auto;
}
.sheet-head{
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 0 16px; border-bottom: 1px solid var(--border); margin-bottom: 16px;
}
.cal-title{ font-weight: 800; font-size: 16px; }
.cal-nav{ display: flex; gap: 8px; flex-wrap: wrap; }
.cal-btn{
  width: 36px; height: 36px; display: grid; place-items: center;
  border-radius: 10px; border: 1px solid var(--border);
  background: var(--elev); color: var(--text); transition: all .15s ease;
}
.cal-btn:hover{ border-color: var(--brand); color: var(--brand); }
.cal-grid{ margin-top:16px; display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
.dow-h{ text-align:center; font-size:12px; color:var(--muted); padding:6px 0; font-weight:700; }
.day{
  height: 42px; border:1px solid var(--border); border-radius:10px;
  background: var(--elev); color: var(--text);
  display:grid; place-items:center; position:relative; cursor:pointer; font-weight:700;
  transition: all .15s ease;
}
.day:hover:not([disabled]){ border-color: var(--brand); background: rgba(124,140,255,0.12); }
.day[disabled]{ opacity:.45; pointer-events:none; }
.day .badge{
  position:absolute; bottom:5px; left:50%; transform:translateX(-50%);
  width:5px; height:5px; border-radius:var(--radius-full); background:#20c3ff;
}
.day.today{ outline: 2px solid var(--ring); }
.day.selected{ background: rgba(124,140,255,0.15); border-color: var(--brand); }

.dialog{
  position: fixed; inset: 0; display: none; place-items: center; z-index: 70;
  background: rgba(15,23,42,0.65); backdrop-filter: blur(4px);
}
.dialog.open{ display: grid; }
.dialog-card{
  width: min(92vw, 460px); background: var(--card); border: 1px solid var(--border);
  border-radius: 16px; padding: 20px; box-shadow: var(--shadow-lg);
}
.dialog-title{ font-weight:800; margin-bottom:8px; font-size:16px; }
.dialog-body{ color:var(--muted); font-size:15px; line-height:1.5; margin-bottom:16px; }
.dialog-actions{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
.btn{
  padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border);
  background: var(--elev); color: var(--text); font-weight: 700; cursor: pointer;
  transition: all .15s ease; font-size: 14px;
}
.btn:hover{ border-color: var(--brand); color: var(--brand); }
.btn.primary{ background: linear-gradient(135deg, #7c8cff, #20c3ff); color:#fff; border:0; box-shadow: var(--shadow); }
.btn.primary:hover{ box-shadow: var(--shadow-md); transform: translateY(-1px); }

/* ----------- OFFLINE BANNER ----------- */
.offline{
  position: fixed;
  top: calc(12px + var(--safe-top));
  left: 50%;
  transform: translateX(-50%);
  background: rgba(245,158,11,0.15);
  color: var(--text);
  border: 1px solid rgba(245,158,11,0.35);
  padding: 8px 14px;
  border-radius: var(--radius-full);
  font-size: 13px;
  font-weight: 700;
  z-index: 80;
  display: none;
  max-width: 90vw;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  box-shadow: var(--shadow);
}
.offline.show{ display: flex; align-items: center; gap: 8px; }

/* ----------- UTILITIES ----------- */
[hidden]{ display: none !important; }
@media (max-width: 400px){
  #dateMain{ font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 56vw; }
  .btn-outline{ padding: 6px 10px; }
}
@media (min-width: 900px){
  .app{ max-width: 820px; } /* subtle widen on large screens, stay 1-col */
}
@media (max-height: 650px){
  .planner-card{ padding: 6px; }
  .panel{ padding: 8px; }
}
@media (prefers-reduced-motion: reduce){
  *{ animation: none !important; transition: none !important; }
}

/* Inputs baseline */
input, button, textarea { appearance: none; -webkit-appearance: none; border-radius: var(--radius); font-family: inherit; }

/* ----------- MODEL BADGE & SELECT STYLES ----------- */
.model-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 6px;
  vertical-align: middle;
  letter-spacing: 0.3px;
  box-shadow: var(--shadow-sm);
}
.model-badge.basic {
  background: rgba(124,140,255,.15);
  color: var(--brand);
  border: 1px solid rgba(124,140,255,.25);
}
.model-badge.advanced {
  background: linear-gradient(135deg, rgba(124,140,255,.2), rgba(32,195,255,.2));
  color: var(--brand-2);
  border: 1px solid rgba(32,195,255,.3);
}

.select-wrapper {
  position: relative;
  width: 100%;
}
.select-wrapper::after {
  content: "\f107";
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
}
select {
  appearance: none;
  width: 100%;
  padding: 12px 14px;
  padding-right: 36px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--elev);
  color: var(--text);
  font-family: inherit;
  font-weight: 500;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.15s ease;
  box-shadow: var(--shadow-sm);
}
select:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 2px var(--ring);
}
.model-desc {
  margin-top: 6px;
  font-size: 12px;
  color: var(--muted);
  line-height: 1.4;
  padding-left: 2px;
  transition: opacity 0.15s ease;
}
</style>

</head>
<body>
<div class="app" id="app">
  <!-- Topbar -->
  <header>
    <div class="topbar">
      <div class="logo">
        <i class="fa-solid fa-bolt"></i> 
        LifeBite
        <span id="modelBadge" class="model-badge basic" style="cursor:pointer;" title="Click to switch model">Basic</span>
      </div>
      <div class="spacer"></div>
      <button class="icon-btn" id="themeToggle" aria-label="Toggle theme"><i class="fa-solid fa-moon"></i></button>
      <button class="icon-btn" id="settingsBtn" aria-label="Settings"><i class="fa-solid fa-gear"></i></button>
      <button class="icon-btn" id="insightsBtn" aria-label="Insights"><i class="fa-solid fa-chart-line"></i></button>
    </div>

    <!-- Planner Card -->
    <div class="planner">
      <div class="planner-card">
        <button class="nav-btn" id="prevDay" aria-label="Previous day"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="date-title" id="dateTitle" role="button" aria-label="Open calendar">
          <div id="dateMain">Today</div>
          <div class="date-sub" id="dateSub">Sun, Aug 17</div>
        </div>
        <button class="nav-btn" id="nextDay" aria-label="Next day"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="today-pill" id="jumpToday">Today</button>

        <!-- Week strip inside same card -->
        <div class="week-strip" id="weekStrip" aria-label="Week strip"></div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- Logs -->
    <section class="panel flex-col" aria-labelledby="logsTitle" id="logsPanel">
      <div class="logs-head">
        <div style="display:flex; align-items:center; gap:8px;">
          <div id="logsTitle" style="font-weight:800;">Bites</div>
          <span id="analyzingSpin" class="spin" hidden title="Analyzing"></span>
        </div>
        <div class="logs-actions">
          <button class="btn-outline btn-danger" id="clearDay"><i class="fa-solid fa-trash"></i> Clear</button>
          <button class="btn-outline" id="genSummary"><i class="fa-solid fa-brain"></i> <span id="summaryBtnText">Summarize</span></button>
        </div>
      </div>

      <ul class="log-list" id="logList" role="list"></ul>
      <div class="error" id="emptyState" hidden><i class="fa-solid fa-pencil"></i> No logs for this day.</div>
    </section>

    <!-- Results -->
    <section class="panel" id="resultsPanel" hidden>
      <div class="logs-head">
        <div style="font-weight:800;">Summary</div>
        <button class="btn-outline" id="backToLogs"><i class="fa-solid fa-arrow-left"></i> Back</button>
      </div>
      <div id="resultsContainer"></div>
      <div class="error" id="errorState" hidden><i class="fa-solid fa-circle-exclamation"></i> Couldn't generate advice. Try again.</div>
    </section>
  </main>
  
  <!-- Composer -->
  <div class="composer" id="composerWrap">
    <div class="composer-card">
      <div class="compose-row">
        <textarea id="composer" placeholder="What happened? (max 256 chars)" maxlength="256" rows="1"></textarea>
        <button class="send" id="send" title="Add"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
      <div class="meta">
        <div id="streakText">Streak: 0</div>
        <div><span id="charCount" class="count">0/256</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Offline banner -->
<div class="offline" id="offlineBanner"><i class="fa-solid fa-wifi"></i> You're offline. Actions will queue.</div>

<!-- Calendar Modal -->
<div class="modal" id="calendarModal" aria-hidden="true">
  <div class="sheet">
    <div class="sheet-head">
      <button class="cal-btn" id="calPrev" aria-label="Previous month"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="cal-title" id="calTitle">August 2025</div>
      <div class="cal-nav">
        <button class="cal-btn" id="calToday" aria-label="Jump to today"><i class="fa-solid fa-bullseye"></i></button>
        <button class="cal-btn" id="calNext" aria-label="Next month"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="cal-btn" id="calClose" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="dialog" id="confirmDialog" aria-hidden="true">
  <div class="dialog-card">
    <div class="dialog-title" id="confirmTitle">Clear data?</div>
    <div class="dialog-body" id="confirmBody">This permanently deletes logs and summary for this day.</div>
    <div class="dialog-actions">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">Clear</button>
    </div>
  </div>
</div>

<!-- Settings Dialog -->
<div class="dialog" id="settingsDialog" aria-hidden="true">
  <div class="dialog-card">
    <div class="dialog-title">Settings</div>
    <div class="dialog-body">
      <div style="display:grid; gap:12px; margin-top:8px;">
        <label style="font-size:13px; color:var(--text); font-weight:600;">AI Model</label>
        <div class="select-wrapper">
          <select id="modelSelect">
            <option value="free">Basic Model</option>
            <option value="paid">Advanced Model (Premium)</option>
          </select>
        </div>
        <div id="modelDescription" class="model-desc">
          Basic personalized advice for your daily logs.
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;">
          <button class="btn" id="exportBtn"><i class="fa-solid fa-file-export"></i> Export</button>
          <label class="btn" for="importInput" style="cursor:pointer;"><i class="fa-solid fa-file-import"></i> Import</label>
          <input id="importInput" type="file" accept="application/json" hidden />
          <button class="btn" id="themeSystem"><i class="fa-solid fa-circle-half-stroke"></i> System</button>
          <button class="btn" id="themeLight"><i class="fa-regular fa-sun"></i> Light</button>
          <button class="btn" id="themeDark"><i class="fa-solid fa-moon"></i> Dark</button>
        </div>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="settingsClose">Close</button>
      <button class="btn primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
const today = new Date(); today.setHours(0,0,0,0);
let current = new Date(); current.setHours(0,0,0,0);
let calMonth = new Date(today.getFullYear(), today.getMonth(), 1);

const fmtISO = d => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
const clampToToday = d => (d > today) ? new Date(today) : d;

/* ---------- Storage Keys ---------- */
const STORAGE_PREFIX = 'lifebite';
const keyLogs = (d)=> `${STORAGE_PREFIX}:logs:${fmtISO(d)}`;
const keySummary = (d)=> `${STORAGE_PREFIX}:summary:${fmtISO(d)}`;
const keyTheme = `${STORAGE_PREFIX}:theme`;
const keyModel = `${STORAGE_PREFIX}:model`;
const keyQueue = `${STORAGE_PREFIX}:queue`;

function getLogs(d=current){ try{ return JSON.parse(localStorage.getItem(keyLogs(d))||'[]'); }catch{ return []; } }
function setLogs(arr, d=current){ localStorage.setItem(keyLogs(d), JSON.stringify(arr)); }
function getSummary(d=current){ try{ return JSON.parse(localStorage.getItem(keySummary(d))||'null'); }catch{ return null; } }
function setSummary(obj, d=current){ localStorage.setItem(keySummary(d), JSON.stringify(obj)); }
function getModel(){ return localStorage.getItem(keyModel) || 'free'; }
function setModel(v){ localStorage.setItem(keyModel, v); }
function getEndpoint(){ return 'https://lifebite.vercel.app/api/lifebite'; }
function dayHasLogs(d){ return getLogs(d).length > 0; }
function streak(){ let s=0, d=new Date(today); while(dayHasLogs(d)){ s++; d.setDate(d.getDate()-1); } return s; }

/* ---------- Theme ---------- */
let themeStored = localStorage.getItem(keyTheme);
if (!themeStored) {
  themeStored = 'dark';
  localStorage.setItem(keyTheme, 'dark');
}
applyTheme(themeStored);

$('#themeToggle').addEventListener('click', ()=>{ const cur = localStorage.getItem(keyTheme) || 'system'; const next = (cur==='system') ? 'dark' : (cur==='dark' ? 'light' : 'system'); localStorage.setItem(keyTheme,next); applyTheme(next); });
$('#themeSystem').addEventListener('click', ()=>{ localStorage.setItem(keyTheme,'system'); applyTheme('system'); });
$('#themeLight').addEventListener('click', ()=>{ localStorage.setItem(keyTheme,'light'); applyTheme('light'); });
$('#themeDark').addEventListener('click', ()=>{ localStorage.setItem(keyTheme,'dark'); applyTheme('dark'); });

function applyTheme(mode){
  if(mode==='system'){ document.documentElement.removeAttribute('data-theme'); }
  else{ document.documentElement.setAttribute('data-theme', mode); }
  const dark = (mode==='system') ? window.matchMedia('(prefers-color-scheme: dark)').matches : (mode==='dark');
  $('#themeToggle').querySelector('i').className = dark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
}

/* ---------- Model Badge & Description ---------- */
function updateModelUI(modelType = null) {
  const model = modelType || getModel();
  const badge = $('#modelBadge');
  const description = $('#modelDescription');
  
  // Update badge
  if (model === 'paid') {
    badge.className = 'model-badge advanced';
    badge.textContent = 'Advanced';
  } else {
    badge.className = 'model-badge basic';
    badge.textContent = 'Basic';
  }
  
  // Update description
  if (model === 'paid') {
    description.textContent = 'More personalized and detailed advice with advanced insights.';
  } else {
    description.textContent = 'Basic personalized advice for your daily logs.';
  }
}

/* ---------- Header + Week Strip ---------- */
const daysShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const monthsLong = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function renderHeader(){
  const isToday = current.getTime()===today.getTime();
  $('#dateMain').textContent = isToday ? 'Today' : `${monthsLong[current.getMonth()]} ${current.getDate()}, ${current.getFullYear()}`;
  $('#dateSub').textContent = `${daysShort[current.getDay()]}, ${monthsLong[current.getMonth()].slice(0,3)} ${current.getDate()}`;
  $('#nextDay').disabled = isToday;
  $('#jumpToday').disabled = isToday;
  updateSummaryButton();
  $('#streakText').textContent = `Streak: ${streak()}`;
}
function updateSummaryButton() {
  const summaryExists = getSummary(current) !== null;
  const btnIcon = $('#genSummary i');
  const btnText = $('#summaryBtnText');
  if (summaryExists) { btnIcon.className = 'fa-solid fa-check'; btnText.textContent = 'View Summary'; }
  else { btnIcon.className = 'fa-solid fa-brain'; btnText.textContent = 'Summary'; }
}

function weekStart(d){ const t = new Date(d); const diff = t.getDay(); t.setDate(t.getDate()-diff); return t; }

function renderWeekStrip(){
  const root = $('#weekStrip'); root.innerHTML='';
  const start = weekStart(current);
  for(let i=0;i<7;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const chip = document.createElement('button');
    chip.className='day-chip'+(fmtISO(d)===fmtISO(current)?' active':'') + (dayHasLogs(d)?' haslogs':'');
    chip.setAttribute('data-date', fmtISO(d));
    chip.innerHTML = `<div class="dow">${daysShort[d.getDay()]}</div><div class="d">${d.getDate()}</div><div class="dot"></div>`;
    chip.disabled = d.getTime()>today.getTime();
    chip.addEventListener('click', ()=>{ current = d; afterDateChanged(); });
    root.appendChild(chip);
  }
  updateWeekLayout();
  centerActiveChip();
}

/* Fit detection so iPad/desktop shows fixed 7 columns */
function updateWeekLayout(){
  const ws = $('#weekStrip');
  const chips = $$('.day-chip', ws);
  if(!chips.length){ ws.classList.remove('full'); return; }
  const cs = getComputedStyle(ws);
  const gap = parseFloat(cs.columnGap || cs.gap) || 8;
  const chipW = chips[0].getBoundingClientRect().width || 60;
  const total = chipW * 7 + gap * 6 + 2;
  ws.classList.toggle('full', ws.clientWidth >= total);
}
function centerActiveChip(){
  const ws = $('#weekStrip');
  if(ws.classList.contains('full')) return;
  const active = $('.day-chip.active', ws);
  if(active) active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
}

/* Swipe on header area to change day */
let touchX = null;
$('.planner').addEventListener('touchstart', e=>{ touchX = e.touches[0].clientX; }, {passive:true});
$('.planner').addEventListener('touchend', e=>{
  if(touchX===null) return;
  const dx = e.changedTouches[0].clientX - touchX;
  if(Math.abs(dx) > 50){ navigate(dx<0? +1 : -1); }
  touchX = null;
});

/* ---------- Calendar ---------- */
const calModal = $('#calendarModal');
$('#dateTitle').addEventListener('click', openCalendar);
$('#calClose').addEventListener('click', closeCalendar);
$('#calPrev').addEventListener('click', ()=>{ calMonth.setMonth(calMonth.getMonth()-1); renderCalendar(); });
$('#calNext').addEventListener('click', ()=>{ const next = new Date(calMonth); next.setMonth(next.getMonth()+1); const afterNext = new Date(next.getFullYear(), next.getMonth()+1, 0); if(afterNext > today){ return; } calMonth = next; renderCalendar(); });
$('#calToday').addEventListener('click', ()=>{ calMonth = new Date(today.getFullYear(), today.getMonth(), 1); renderCalendar(); });

function openCalendar(){ calMonth = new Date(current.getFullYear(), current.getMonth(), 1); renderCalendar(); calModal.classList.add('open'); calModal.setAttribute('aria-hidden','false'); }
function closeCalendar(){ calModal.classList.remove('open'); calModal.setAttribute('aria-hidden','true'); }
calModal.addEventListener('click', e=>{ if(e.target===calModal) closeCalendar(); });

function renderCalendar(){
  $('#calTitle').textContent = `${monthsLong[calMonth.getMonth()]} ${calMonth.getFullYear()}`;
  const grid = $('#calGrid'); grid.innerHTML='';
  daysShort.forEach(d=>{ const h=document.createElement('div');h.textContent=d;h.className='dow-h';grid.appendChild(h); });

  const first = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1);
  const last  = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 0);
  const startOffset = first.getDay();
  const totalCells = Math.ceil((startOffset + last.getDate())/7)*7;

  for(let i=0;i<totalCells;i++){
    const cell = document.createElement('button'); cell.className='day';
    const dateNum = i - startOffset + 1;
    if(dateNum < 1 || dateNum > last.getDate()){ cell.setAttribute('disabled',''); cell.style.visibility='hidden'; grid.appendChild(cell); continue; }
    const d = new Date(calMonth.getFullYear(), calMonth.getMonth(), dateNum);
    cell.textContent = dateNum;
    if(d.getTime()>today.getTime()) cell.setAttribute('disabled','');
    if(fmtISO(d)===fmtISO(today)) cell.classList.add('today');
    if(fmtISO(d)===fmtISO(current)) cell.classList.add('selected');
    if(dayHasLogs(d)){ const b=document.createElement('div'); b.className='badge'; cell.appendChild(b); }
    cell.addEventListener('click', ()=>{ current = d; afterDateChanged(); closeCalendar(); });
    grid.appendChild(cell);
  }
}

/* ---------- Navigation ---------- */
$('#prevDay').addEventListener('click', ()=> navigate(-1));
$('#nextDay').addEventListener('click', ()=> navigate(+1));
$('#jumpToday').addEventListener('click', ()=>{ current = new Date(today); afterDateChanged(); });
function navigate(offset){ const nd = new Date(current); nd.setDate(current.getDate()+offset); current = clampToToday(nd); afterDateChanged(); }

function afterDateChanged(){
  renderHeader(); renderWeekStrip(); renderLogs();
  updateComposerState();
  $('#resultsPanel').hidden = true;
  $('#logsPanel').hidden = false;
}

/* ---------- Logs ---------- */
const logList = $('#logList');
const emptyState = $('#emptyState');

function renderLogs(){
  const logs = getLogs();
  logList.innerHTML = '';
  if(!logs || logs.length === 0){
    emptyState.hidden = false; logList.hidden = true;
  }else{
    emptyState.hidden = true; logList.hidden = false;
    const hasSummary = getSummary(current) !== null;
    logs.forEach((l, index) => {
      const li = document.createElement('li'); 
      li.className = 'log-item';

      const header = document.createElement('div');
      header.className = 'log-header';

      const tm = document.createElement('div'); 
      tm.className = 'log-time';
      const d = new Date(l.timestamp);
      tm.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      header.appendChild(tm);

      const actions = document.createElement('div');
      actions.className = 'log-actions';

      if (!hasSummary) {
        const del = document.createElement('button');
        del.className = 'log-btn';
        del.innerHTML = '<i class="fa-solid fa-xmark"></i> Delete';
        del.addEventListener('click', () => deleteLog(index));
        actions.appendChild(del);
      }

      header.appendChild(actions);
      li.appendChild(header);

      const txt = document.createElement('div'); 
      txt.className = 'log-content';
      txt.textContent = l.text;
      li.appendChild(txt);

      logList.appendChild(li);
    });
    logList.scrollTop = 0;
  }
}
function deleteLog(index){
  if (getSummary(current)) { alert('Cannot delete logs after a summary is generated. Clear all data first.'); return; }
  const logs = getLogs();
  logs.splice(index, 1);
  setLogs(logs);
  renderLogs();
  renderWeekStrip();
  renderHeader();
  if (logs.length === 0) { emptyState.hidden = false; logList.hidden = true; }
}

/* ---------- Composer ---------- */
const composer = $('#composer');
const sendBtn = $('#send');
const charCount = $('#charCount');

composer.addEventListener('input', ()=>{
  composer.style.height = 'auto';
  composer.style.height = Math.min(composer.scrollHeight, 144) + 'px';
  const len = composer.value.length;
  charCount.textContent = `${len}/256`;
  charCount.classList.toggle('limit', len>225);
});
composer.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); addLog(); }
});
sendBtn.addEventListener('click', addLog);

function addLog(){
  const text = composer.value.trim();
  if(!text) return;
  if(text.length>256){ alert('Max 256 characters.'); return; }
  if(current > today){ alert('No bites allowed for future dates.'); return; }
  if(getSummary(current)){ alert('Adding Bites. Clear all data first.'); return; }

  const logs = getLogs();
  logs.unshift({ text, timestamp: new Date().toISOString() });
  setLogs(logs);
  composer.value=''; composer.dispatchEvent(new Event('input'));
  renderLogs(); renderWeekStrip(); renderHeader();
  emptyState.hidden = true; logList.hidden = false;
}
function updateComposerState() {
  const hasSummary = getSummary(current) !== null;
  composer.disabled = hasSummary;
  sendBtn.disabled = hasSummary;
  composer.placeholder = hasSummary ? "No bites allowed after summary" : "What happened? (max 256 chars)";
}

/* ---------- Clear Day ---------- */
const confirmDlg = $('#confirmDialog');
$('#clearDay').addEventListener('click', ()=>{
  $('#confirmTitle').textContent = `Clear ${fmtISO(current)}?`;
  $('#confirmBody').textContent = 'This will permanently delete all logs and the LifeBite summary for this day.';
  confirmDlg.classList.add('open'); confirmDlg.setAttribute('aria-hidden','false');
});
$('#confirmCancel').addEventListener('click', ()=>{ confirmDlg.classList.remove('open'); confirmDlg.setAttribute('aria-hidden','true'); });
$('#confirmOk').addEventListener('click', ()=>{
  localStorage.removeItem(keyLogs(current));
  localStorage.removeItem(keySummary(current));
  $('#resultsPanel').hidden = true;
  $('#resultsContainer').innerHTML = '';
  $('#errorState').hidden = true;
  renderLogs(); 
  renderWeekStrip(); 
  renderHeader();
  updateSummaryButton();
  updateComposerState();
  confirmDlg.classList.remove('open'); confirmDlg.setAttribute('aria-hidden','true');
});

/* ---------- Summary / AI ---------- */
const resultsPanel = $('#resultsPanel');
const resultsContainer = $('#resultsContainer');
const errorState = $('#errorState');

$('#genSummary').addEventListener('click', ()=>{
  const saved = getSummary();
  if(saved){ displayResults(saved); return; }
  generateSummary();
});
$('#backToLogs').addEventListener('click', () => {
  resultsPanel.hidden = true;
  $('#logsPanel').hidden = false;
});

function displayResults(result){
  resultsPanel.hidden = false;
  $('#logsPanel').hidden = true;

  let html = '';
  if(result.summary){ html += `<div class="result-card"><div class="summary">${escapeHTML(result.summary)}</div></div>`; }
  html += section('Keep Doing', result.keep_doing, 'fa-thumbs-up');
  html += section('Areas to Improve', result.improve, 'fa-arrow-trend-up');
  html += section('Schedule Adjustments', result.schedule_tweaks, 'fa-calendar-alt');
  html += section('Next Actions', result.next_actions, 'fa-square-check');
  resultsContainer.innerHTML = html;
  updateSummaryButton();
  updateComposerState();
  resultsPanel.scrollIntoView({behavior:'smooth'});
}
function section(title, items, icon){
  if(!items || !items.length) return '';
  const lis = items.map(i=>`<li>${escapeHTML(i)}</li>`).join('');
  return `<div class="result-card"><div class="result-head"><i class="fa-solid ${icon}"></i> ${title}</div><ul class="result-list">${lis}</ul></div>`;
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function generateSummary(){
  const logs = getLogs();
  if(!logs.length){ alert('Add at least one log first.'); return; }

  const summaryBtn = $('#genSummary');
  const btnIcon = $('#genSummary i');
  const btnText = $('#summaryBtnText');
  const originalIcon = btnIcon.className;
  const originalText = btnText.textContent;

  btnIcon.className = 'fa-solid fa-spinner fa-spin';
  btnText.textContent = 'Thinking...';
  summaryBtn.disabled = true;

  resultsPanel.hidden = true;
  resultsContainer.innerHTML='';
  errorState.hidden = true;

  const payload = { 
    date: fmtISO(current), 
    logs: logs.map(l=>l.text),
    model: getModel() // Add model parameter
  };
  const endpoint = getEndpoint();

  if(!navigator.onLine){
    enqueue({ type:'summary', endpoint, payload });
    errorState.hidden = false; errorState.textContent = 'Offline. Queued—will run automatically when back online.';
    resultsPanel.hidden = false;
    btnIcon.className = originalIcon;
    btnText.textContent = originalText;
    summaryBtn.disabled = false;
    return;
  }

  try{
    const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error(String(res.status));
    const data = await res.json();
    setSummary(data.result, current);
    btnIcon.className = 'fa-solid fa-check';
    btnText.textContent = 'View Summary';
    summaryBtn.disabled = false;
    displayResults(data.result);
  }catch(e){
    btnIcon.className = originalIcon;
    btnText.textContent = originalText;
    summaryBtn.disabled = false;
    resultsPanel.hidden = false;
    errorState.hidden = false;
  }
}

/* ---------- Offline queue ---------- */
window.addEventListener('online', flushQueue);
function getQueue(){ try{ return JSON.parse(localStorage.getItem(keyQueue) || '[]'); }catch{ return []; } }
function setQueue(q){ localStorage.setItem(keyQueue, JSON.stringify(q)); }
function enqueue(job){ const q = getQueue(); q.push(job); setQueue(q); showOffline(true); }
async function flushQueue(){
  const q = getQueue(); if(!q.length) return;
  for(const job of q){
    if(job.type==='summary'){
      try{
        const res = await fetch(job.endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(job.payload) });
        if(res.ok){
          const data = await res.json();
          if(job.payload?.date){ const d = new Date(job.payload.date); setSummary(data.result, d); }
        }
      }catch{}
    }
  }
  setQueue([]); showOffline(false); 
  updateSummaryButton();
}

/* ---------- Connectivity banner ---------- */
function showOffline(state){ $('#offlineBanner').classList.toggle('show', state); }
window.addEventListener('online', ()=>showOffline(false));
window.addEventListener('offline', ()=>showOffline(true));
showOffline(!navigator.onLine);

/* ---------- Settings / Export / Import ---------- */
$('#settingsBtn').addEventListener('click', ()=>{ 
  $('#modelSelect').value = getModel(); 
  updateModelUI();
  $('#settingsDialog').classList.add('open'); 
  $('#settingsDialog').setAttribute('aria-hidden','false'); 
});

$('#settingsClose').addEventListener('click', ()=>{ 
  $('#settingsDialog').classList.remove('open'); 
  $('#settingsDialog').setAttribute('aria-hidden','true'); 
});

$('#saveSettings').addEventListener('click', ()=>{ 
  const newModel = $('#modelSelect').value;
  setModel(newModel); 
  updateModelUI(newModel);
  $('#settingsDialog').classList.remove('open'); 
  $('#settingsDialog').setAttribute('aria-hidden','true'); 
});

// Update description when dropdown changes
$('#modelSelect').addEventListener('change', function() {
  updateModelUI(this.value);
});

$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(Object.entries(localStorage).reduce((obj,[k,v])=>{ if(k.startsWith(STORAGE_PREFIX)) obj[k]=v; return obj; },{}), null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `lifebite-backup-${fmtISO(today)}.json`; a.click();
});
$('#importInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    Object.entries(obj).forEach(([k,v])=> localStorage.setItem(k, v));
    afterDateChanged();
    alert('Import complete.');
  }catch{ alert('Invalid file.'); }
});

$('#insightsBtn').addEventListener('click', ()=>{ alert('Insights coming soon: streak heatmap, time-of-day trends, habit tags.'); });

/* ---------- Init ---------- */
function init(){
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  renderHeader(); renderWeekStrip(); renderLogs(); renderCalendar();
  updateComposerState();
  if(!localStorage.getItem(keyModel)){ setModel('paid'); }
  updateModelUI();
  const mql = window.matchMedia('(prefers-color-scheme: dark)');
  mql.addEventListener?.('change', ()=>{ if((localStorage.getItem(keyTheme)||'system')==='system') applyTheme('system'); });
  updateWeekLayout();
}
init();
window.addEventListener('resize', ()=>{ requestAnimationFrame(updateWeekLayout); });
window.addEventListener('orientationchange', ()=>{ setTimeout(updateWeekLayout, 60); });

// Add click-to-toggle for model badge in header
$('#modelBadge').addEventListener('click', () => {
  const currentModel = getModel();
  const nextModel = currentModel === 'free' ? 'paid' : 'free';
  setModel(nextModel);
  updateModelUI(nextModel);
  // Also update the select in settings dialog if open
  const modelSelect = $('#modelSelect');
  if (modelSelect) modelSelect.value = nextModel;
});
</script>
</body>

</html>
